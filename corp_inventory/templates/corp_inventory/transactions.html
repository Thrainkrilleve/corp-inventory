{% extends "corp_inventory/base.html" %}
{% load i18n %}
{% load humanize %}

{% block corp_inventory_content %}
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h1>
                <i class="fas fa-exchange-alt"></i>
                {% if corporation %}
                    {{ corporation.corporation_name }} Transaction Log
                {% else %}
                    Transaction Log
                {% endif %}
            </h1>
            <p class="lead">Track all hangar additions, removals, and changes</p>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="filter-bar">
        <form method="get" class="form-inline">
            {% if not corporation %}
            <div class="form-group">
                <label for="corporation">Corporation:</label>
                <select name="corporation" id="corporation" class="form-control">
                    <option value="">All Corporations</option>
                    {% for corp in corporations %}
                    <option value="{{ corp.corporation_id }}">{{ corp.corporation_name }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            
            <div class="form-group">
                <label for="type">Type:</label>
                <select name="type" id="type" class="form-control">
                    <option value="">All Types</option>
                    <option value="ADD" {% if selected_type == "ADD" %}selected{% endif %}>
                        Addition
                    </option>
                    <option value="REMOVE" {% if selected_type == "REMOVE" %}selected{% endif %}>
                        Removal
                    </option>
                    <option value="CHANGE" {% if selected_type == "CHANGE" %}selected{% endif %}>
                        Quantity Change
                    </option>
                    <option value="MOVE" {% if selected_type == "MOVE" %}selected{% endif %}>
                        Movement
                    </option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="days">Time Period:</label>
                <select name="days" id="days" class="form-control">
                    <option value="1" {% if days_back == "1" %}selected{% endif %}>Last 24 hours</option>
                    <option value="7" {% if days_back == "7" %}selected{% endif %}>Last 7 days</option>
                    <option value="30" {% if days_back == "30" %}selected{% endif %}>Last 30 days</option>
                    <option value="90" {% if days_back == "90" %}selected{% endif %}>Last 90 days</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="search">Item:</label>
                <input type="text" name="search" id="search" class="form-control" 
                       value="{{ search_query }}" placeholder="Item name...">
            </div>
            
            <div class="form-group">
                <label for="character">Character:</label>
                <input type="text" name="character" id="character" class="form-control" 
                       value="{{ character_search }}" placeholder="Character name...">
            </div>
            
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-filter"></i> Filter
            </button>
            
            <a href="{% if corporation %}{% url 'corp_inventory:corporation_transactions' corporation.corporation_id %}{% else %}{% url 'corp_inventory:transactions' %}{% endif %}" 
               class="btn btn-default">
                <i class="fas fa-times"></i> Clear
            </a>
        </form>
    </div>
    
    <!-- Transactions Table -->
    <div class="row">
        <div class="col-md-12">
            <div class="stat-card">
                <h3><i class="fas fa-list"></i> Recent Transactions</h3>
                
                {% if transactions %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Type</th>
                                <th>Item</th>
                                <th>Change</th>
                                <th>Location</th>
                                <th>Division</th>
                                <th class="text-right">Value</th>
                                {% if not corporation %}
                                <th>Corporation</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for trans in transactions %}
                            <tr>
                                <td>
                                    <small>{{ trans.detected_at|date:"Y-m-d H:i" }}</small>
                                    <br>
                                    <small class="text-muted">{{ trans.detected_at|naturaltime }}</small>
                                </td>
                                <td>
                                    {% if trans.transaction_type == "ADD" %}
                                        <span class="label label-success transaction-add">
                                            <i class="fas fa-plus"></i> Addition
                                        </span>
                                    {% elif trans.transaction_type == "REMOVE" %}
                                        <span class="label label-danger transaction-remove">
                                            <i class="fas fa-minus"></i> Removal
                                        </span>
                                    {% elif trans.transaction_type == "CHANGE" %}
                                        <span class="label label-warning transaction-change">
                                            <i class="fas fa-exchange-alt"></i> Change
                                        </span>
                                    {% else %}
                                        <span class="label label-info">
                                            <i class="fas fa-arrows-alt"></i> Movement
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <img src="https://images.evetech.net/types/{{ trans.type_id }}/icon?size=32" 
                                         alt="{{ trans.type_name }}" 
                                         class="item-icon"
                                         onerror="this.style.display='none'">
                                    <strong>{{ trans.type_name }}</strong>
                                </td>
                                <td>
                                    <span class="{% if trans.quantity_change > 0 %}transaction-add{% else %}transaction-remove{% endif %}">
                                        {{ trans.quantity_change|stringformat:"+d"|intcomma }}
                                    </span>
                                    <br>
                                    <small class="text-muted">
                                        {{ trans.old_quantity|intcomma }} â†’ {{ trans.new_quantity|intcomma }}
                                    </small>
                                </td>
                                <td>
                                    <a href="{% url 'corp_inventory:location' trans.location.location_id %}">
                                        {{ trans.location.location_name }}
                                    </a>
                                </td>
                                <td>
                                    {% if trans.division %}
                                        {{ trans.division.division_name }}
                                    {% else %}
                                        <em class="text-muted">N/A</em>
                                    {% endif %}
                                </td>
                                <td class="text-right">
                                    <span class="isk-value">{{ trans.estimated_value|floatformat:2 }}</span>
                                </td>
                                {% if not corporation %}
                                <td>
                                    <a href="{% url 'corp_inventory:corporation_hangar' trans.corporation.corporation_id %}">
                                        {{ trans.corporation.corporation_name }}
                                    </a>
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <p class="text-muted">
                    <small>
                        <i class="fas fa-info-circle"></i>
                        Showing up to 500 most recent transactions
                    </small>
                </p>
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    No transactions found matching your filters.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
